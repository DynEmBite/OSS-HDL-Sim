name: Build GTKWave Win64 (GTK3, r1725, optimized bundle + release)

on:
  workflow_dispatch:
  push:
    tags:
      - "v3.3.126"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout GitHub repo
        uses: actions/checkout@v4

      - name: Install MSYS2 + Dependencies (inkl. SVN)
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >
            base-devel
            subversion
            autoconf
            automake
            libtool
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-libgnurx

      - name: Checkout GTKWave SVN (Revision r1725)
        shell: msys2 {0}
        run: |
          svn checkout -r 1725 https://svn.code.sf.net/p/gtkwave/code/ gtkwave-code

      - name: Build GTKWave (Autotools)
        shell: msys2 {0}
        run: |
          cd gtkwave-code
          ./autogen.sh
          ./configure --prefix=/mingw64
          make -j$(nproc)
          make install

      - name: Create optimized portable bundle
        shell: bash
        run: |
          mkdir -p bundle/bin
          mkdir -p bundle/share

          cp /msys64/mingw64/bin/gtkwave.exe bundle/

          ldd /msys64/mingw64/bin/gtkwave.exe | awk '/mingw64/ {print $3}' | while read dll; do
            cp "$dll" bundle/bin/
          done

          cp -r /msys64/mingw64/share/glib-2.0 bundle/share/
          cp -r /msys64/mingw64/share/icons bundle/share/
          cp -r /msys64/mingw64/share/gtkwave bundle/share/ || true

          mkdir -p bundle/share/themes
          cp -r /msys64/mingw64/share/themes/Adwaita bundle/share/themes/

          echo "@echo off" > bundle/run-gtkwave.bat
          echo "set PATH=%~dp0bin;%PATH%" >> bundle/run-gtkwave.bat
          echo "start gtkwave.exe" >> bundle/run-gtkwave.bat

      - name: Pack bundle
        shell: bash
        run: |
          7z a gtkwave-3.3.126-bin-win64.zip ./bundle/*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gtkwave-3.3.126-bin-win64
          path: gtkwave-3.3.126-bin-win64.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: gtkwave-3.3.126-bin-win64.zip
          name: "GTKWave 3.3.126 (Windows 64-bit)"
          body: |
            Automatisch generiertes Windows‑Bundle für GTKWave 3.3.126.
            Enthält:
            - gtkwave.exe
            - alle benötigten DLLs
            - GTK3 Runtime
            - portable Ordnerstruktur
            - Startskript
